<div class="raid-container" *ngIf="getCurrentUser(); else notLoggedIn">
    <p-toast></p-toast>
    <div class="table-wrapper">
        <table *ngFor="let group of raidGroups" class="raid-table">
            <thead>
            <tr>
                <th>Groupes</th>
                <th>Raids</th>
                <th>Réservation</th>
            </tr>
            </thead>
            <tbody class="raid-table-body">
            <tr>
                <td>Réservation {{ group.groupId }}</td>
                <td>
                    <div *ngFor="let raid of group.raids">
                        {{ raid.name }} ({{ raid.difficulty }}) - {{ raid.date | date:'medium' }}
                    </div>
                </td>
                <td class="logs-icon">
                    <button class="icon-button" (click)="openGroupDetails(group)" pTooltip="Voir les détails">➤</button>
                </td>
            </tr>
            </tbody>
        </table>
        <div *ngIf="isAdmin()" style="margin-bottom: 20px;">
            <p-button label="Créer un raid" (onClick)="openCreateRaidModal()"></p-button>
        </div>

        <p-dialog header="Créer un nouveau raid" [(visible)]="showCreateRaidModal" [modal]="true" (onHide)="closeCreateRaidModal()">
            <div style="margin-top: 10px;">
                <label for="raidDifficulty">Difficulté : </label>
                <p-dropdown id="raidDifficulty" [(ngModel)]="newRaid.difficulty" [options]="difficulties" placeholder="Sélectionner la difficulté"></p-dropdown>
            </div>
            <div style="margin-top: 10px;">
                <label for="raidDate">Date (mardi uniquement) : </label>
                <p-calendar
                        id="raidDate"
                        [appendTo]="'body'"
                        [(ngModel)]="newRaid.date"
                        [disabledDays]="disabledDays"
                        [showIcon]="true"
                        dateFormat="dd/mm/yy"
                        placeholder="Sélectionner un mardi"
                        [style]="{ 'font-size': '0.85rem', 'width': '260px' }"
                />
            </div>
            <div style="margin-top: 20px;">
                <p-button label="Créer" (onClick)="createRaid()"></p-button>
            </div>
        </p-dialog>
    </div>

    <div *ngIf="raidGroups.length === 0">
        Aucun raid disponible.
    </div>

    <div class="modal-overlay" *ngIf="selectedGroup">
        <div class="modal-content">
            <button class="close-icon" (click)="closeGroupDetails()">✕</button>
            <div class="boss-list">
                <h3>Bosses</h3>
                <div *ngIf="selectedGroup.bosses && selectedGroup.bosses.length > 0; else noBosses">
                    <div class="boss-item" [class.selected]="boss === selectedBoss" *ngFor="let boss of selectedGroup.bosses" (click)="selectBoss(boss)">
                        <img *ngIf="boss.iconUrl" class="boss-icon" [src]="boss.iconUrl" alt="{{ boss.name }}" />
                        <span class="boss-name">{{ boss.name }}</span>
                    </div>
                </div>
                <ng-template #noBosses>
                    <p>Aucun boss disponible.</p>
                </ng-template>
            </div>

            <div class="loot-list" *ngIf="selectedBoss">
                <table class="loot-table">
                    <thead>
                    <tr>
                        <th>Loot</th>
                        <th>Slot</th>
                        <th>Reserved By</th>
                        <th>Drop</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let loot of selectedBoss.loots">
                        <td>
                            <img *ngIf="loot.iconUrl" class="item-icon" [src]="loot.iconUrl" alt="{{ loot.itemName }}" />
                            <a class="loot-name" href="https://www.wowhead.com/item={{ loot.itemId }}" target="_blank">{{ loot.itemName }}</a>
                        </td>
                        <td class="loot-slot">{{ loot.slot }}</td>
                        <td>
                            <ng-container *ngIf="loot.softReservedBy && loot.softReservedBy.length > 0; else noReservation">
                                    <span *ngFor="let player of loot.softReservedBy; let isLast = last">
                                        <span class="player-tag" [class.current-user]="player === getCurrentUser()" [pTooltip]="player">
                                            {{ player }}{{ isLast ? '' : ', ' }}
                                        </span>
                                    </span>
                            </ng-container>
                            <ng-template #noReservation>
                                <span class="player-tag">None</span>
                            </ng-template>
                        </td>
                        <td class="loot-slot"></td>
                        <td>
                            <button class="reserve-button" (click)="addReservation(selectedBoss.name, loot.itemId)"
                                    *ngIf="!loot.softReservedBy.includes(getCurrentUser())">
                                Reserve
                            </button>
                            <button class="reserve-button" (click)="removeReservation(selectedBoss.name, loot.itemId)"
                                    *ngIf="loot.softReservedBy.includes(getCurrentUser())">
                                Annuler
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #notLoggedIn>
    <app-login-modal [visible]="showLoginModal" (visibleChange)="onLoginModalClose()"></app-login-modal>
</ng-template>